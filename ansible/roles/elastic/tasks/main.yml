
- name: Get master node todo count
  uri: 
    url: "http://{{consul_ips[0]}}:8500/v1/kv/{{ customer_id }}/settings/elasticsearch/master_node_count_todo?raw" 
    return_content: yes
  register: master_node_count_todo

- name: Get data node todo count
  uri: 
    url: "http://{{consul_ips[0]}}:8500/v1/kv/{{ customer_id }}/settings/elasticsearch/data_node_count_todo?raw" 
    return_content: yes
  register: data_node_count_todo

- name: Run compose if todo > 0
  include: compose.yml
  vars: 
    node_type: "master"
    node_id: "{{ master_node_count_todo.content }}"
    is_master_node: true
    is_data_node: false
    min_port_1: 9100
    max_port_1: 9199
    min_port_2: 9200
    max_port_2: 9299
  when: "{{ master_node_count_todo.content | int }} > 0"

- name: Run compose if todo > 0
  include: compose.yml
  vars: 
    node_type: "data"
    node_id: "{{ data_node_count_todo.content }}"
    is_master_node: false
    is_data_node: true
    min_port_1: 9300
    max_port_1: 9399
    min_port_2: 9400
    max_port_2: 9499
  when: "{{ data_node_count_todo.content | int }} > 0"

- name: Set todo master count
  uri:
    url: "http://{{consul_ips[0]}}:8500/v1/kv/{{ customer_id }}/settings/elasticsearch/master_node_count_todo"
    method: PUT
    body: "{{ master_node_count_todo.content | int  - 1}}"  

- name: Set todo data count
  uri:
    url: "http://{{consul_ips[0]}}:8500/v1/kv/{{ customer_id }}/settings/elasticsearch/data_node_count_todo"
    method: PUT
    body: "{{ data_node_count_todo.content | int - 1}} "  
