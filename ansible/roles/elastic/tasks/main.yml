---
# tasks file for elastic

 #- debug: var=vars

 - name: update vm_max_map_count
   command: /sbin/sysctl -w vm.max_map_count=400000

 - name: Install Elasticsearch Repo Key
   rpm_key: key=https://packages.elastic.co/GPG-KEY-elasticsearch state=present
   tags: 'elastic-repo'

 - name: Install Elasticsearch Server Repos
   copy: src=elastic.repo dest=/etc/yum.repos.d/elastic.repo
   tags: 'elastic-repo'

 - name: Install Curator Repo
   copy: src=curator.repo dest=/etc/yum.repos.d/curator.repo
   tags: 'elastic-repo'

 - name: Install Java
   yum: name=java-1.8.0-openjdk-headless state=present

 - name: Install Elasticsearch (installing with url as yum repo has 5.0.0-alpha5)
   yum: name="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.0.0.rpm" state=present

 - name: Create Elasticsearch data directories
   file: path=/mnt/es/data state=directory owner=elasticsearch

 - name: Create Elasticsearch log directories
   file: path=/mnt/es/logs state=directory owner=elasticsearch

 - name: Elasticsearch config file edits
   template: src=elasticsearch.yml.j2 dest=/etc/elasticsearch/elasticsearch.yml

 - name: Ensure elastic environment variables are set.
   blockinfile:
       dest: /etc/sysconfig/elasticsearch
       marker: "# <!-- {mark} ANSIBLE MANAGED BLOCK -->"
       block: |
               MAX_OPEN_FILES=65535
               MAX_LOCKED_MEMORY=unlimited
               ES_JAVA_OPTS="-Xms4g -Xmx4g"

 - name: Start Elasticsearch Service
   service: name=elasticsearch state=restarted enabled=true

 - name: Install Elasticsearch x-pack
   command: /usr/share/elasticsearch/bin/elasticsearch-plugin install x-pack
   become: true
   ignore_errors: true

 - name: Restart Elasticsearch Service for x-pack
   service: name=elasticsearch state=restarted enabled=true

 - name: Wait for elastic
   wait_for: port=9200 delay=1 timeout=60 host="{{ bind_address }}"

 - name: Register elasticsearch service in consul
   uri:
    url: http://{{consul_ips[0]}}:8500/v1/agent/service/register 
    method: PUT
    body: "{{ lookup('template','elasticsearch.service.json.j2') }}"
    status_code: 200
    body_format: json
 
 - name: Install license
   uri:
     url: "http://{{ bind_address }}:9200/_xpack/license"
     method: PUT
     user: elastic
     password: changeme
     body: "{{ lookup('file', 'license.json') }}"
     body_format: json
     return_content: yes

 - name: Get password from consul
   uri: 
    url: "http://{{ consul_ips[0] }}:8500/v1/kv/{{ customer_id }}/settings/elasticsearch/elastic/password?raw" 
    return_content: true
   register: password
  
 - name: Update password for elastic user
   uri:
    url: http://{{ bind_address }}:9200/_xpack/security/user/elastic/_password
    method: PUT
    user: elastic
    password: changeme
    body: "{{ lookup('template', 'pwd.json.j2') }}"
    body_format: json
   register: output
  
 - include: curator.yml
   tags: curator
